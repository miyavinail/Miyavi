// 配置
const CONFIG = {
    LIFF_ID: '2008235894-KBlBRgrN',
    GAS_WEB_APP_URL: 'https://member-api.miyavinail.workers.dev/'
};

let currentUserProfile = null;

// 改进的LIFF初始化
async function initializeLiff() {
    console.log('=== LIFF初始化开始 ===');
    
    try {
        // 首先检查是否在LINE环境中
        const isInLine = /Line/i.test(navigator.userAgent);
        console.log('LINE环境检测:', isInLine);
        
        if (!isInLine) {
            console.log('不在LINE环境中，显示手动输入');
            showManualInput();
            return;
        }

        // 在LINE环境中初始化LIFF
        await liff.init({ 
            liffId: CONFIG.LIFF_ID 
        });
        console.log('✅ LIFF初始化成功');
        
        if (!liff.isLoggedIn()) {
            console.log('用户未登录，执行登录');
            liff.login();
            return;
        }

        // 获取用户信息
        const profile = await liff.getProfile();
        console.log('✅ 获取LINE用户信息成功:', profile);
        
        // 加载会员数据
        await loadMemberData(profile.userId, profile.displayName);
        
    } catch (error) {
        console.error('❌ LIFF初始化失败:', error);
        
        // 更详细的错误处理
        if (error.message.includes('LIFF_ID')) {
            showError('LIFF配置错误，请联系管理员');
        } else if (error.message.includes('network')) {
            showError('网络连接失败，请检查网络后重试');
        } else {
            // 其他错误显示手动输入
            showManualInputWithError(error.message);
        }
    }
}

// 改进的错误显示
function showManualInputWithError(errorMsg) {
    document.getElementById('profileContent').innerHTML = `
        <div style="text-align: center; padding: 20px;">
            <div style="color: #dc3545; margin-bottom: 15px;">
                ⚠️ 自动查询失败: ${errorMsg}
            </div>
            <h3>积分查询</h3>
            <p style="color: #666; margin-bottom: 20px;">请输入您的用户ID查询积分</p>
            <input type="text" id="manualUserId" placeholder="输入用户ID" 
                   style="padding: 12px; width: 80%; margin: 10px; border: 2px solid #667eea; border-radius: 8px; font-size: 16px;">
            <button onclick="manualQuery()" 
                    style="padding: 12px 24px; background: #667eea; color: white; border: none; border-radius: 8px; cursor: pointer; font-size: 16px;">
                查询积分
            </button>
            <div style="margin-top: 20px; padding: 15px; background: #f8f9fa; border-radius: 8px;">
                <small>提示：用户ID可以在之前的记录中找到，或向店员询问</small>
            </div>
        </div>
    `;
}

// 添加健康检查函数
async function healthCheck() {
    try {
        const response = await fetch(`${CONFIG.GAS_WEB_APP_URL}?method=healthCheck`);
        const data = await response.json();
        return data.status === 'success';
    } catch (error) {
        console.error('健康检查失败:', error);
        return false;
    }
}

// 页面加载后初始化
window.onload = async function() {
    // 先显示加载中
    showMessage('系统初始化中...');
    
    // 可选：先检查后端服务状态
    const isBackendHealthy = await healthCheck();
    if (!isBackendHealthy) {
        showError('后端服务暂时不可用，请稍后重试');
        return;
    }
    
    // 初始化LIFF
    await initializeLiff();
};
