<!DOCTYPE html>
<html lang="zh">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>æˆ‘çš„ä¼šå‘˜ç§¯åˆ†</title>
  <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 0;
      padding: 20px;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: #333;
      min-height: 100vh;
    }
    .container {
      max-width: 400px;
      margin: 0 auto;
      background: white;
      padding: 25px;
      border-radius: 20px;
      box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
    }
    .points-card {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      padding: 25px;
      border-radius: 15px;
      text-align: center;
      margin: 20px 0;
    }
    .loading,
    .error {
      text-align: center;
      padding: 40px 20px;
    }
    .error {
      background: #f8d7da;
      color: #721c24;
      border-radius: 10px;
    }
    .loading-spinner {
      border: 3px solid #f3f3f3;
      border-top: 3px solid #667eea;
      border-radius: 50%;
      width: 30px;
      height: 30px;
      animation: spin 1s linear infinite;
      margin: 20px auto;
    }
    @keyframes spin {
      0% {
        transform: rotate(0deg);
      }
      100% {
        transform: rotate(360deg);
      }
    }
    .debug-info {
      background: #f8f9fa;
      border: 1px solid #dee2e6;
      border-radius: 8px;
      padding: 10px;
      margin: 10px 0;
      font-size: 12px;
      color: #666;
      display: none;
    }
    .login-prompt {
      text-align: center;
      padding: 30px 20px;
      background: #e7f3ff;
      border-radius: 10px;
      margin: 20px 0;
    }
  </style>
</head>
<body>
  <div class="container">
    <button onclick="toggleDebug()" style="padding:5px 10px;font-size:12px;margin-bottom:10px;">è°ƒè¯•ä¿¡æ¯</button>
    <div id="debugInfo" class="debug-info"></div>

    <div style="text-align:center;margin-bottom:20px;">
      <div style="font-size:1.4em;color:#667eea;font-weight:bold;">æˆ‘çš„åº—é“º</div>
      <div style="color:#666;">ä¼šå‘˜ä¸­å¿ƒ</div>
    </div>

    <div id="profileContent">
      <div class="loading">åˆå§‹åŒ–ä¸­...</div>
    </div>
  </div>

  <script>
    const CONFIG = {
      LIFF_ID: "2008235894-KBlBRgrN",
      GAS_WEB_APP_URL: "https://member-api.miyavinail.workers.dev/",
    };

    let debugLogs = [];
    function addDebugLog(message, data = null) {
      const timestamp = new Date().toLocaleTimeString();
      const logEntry = `[${timestamp}] ${message} ${
        data ? JSON.stringify(data) : ""
      }`;
      debugLogs.push(logEntry);
      console.log(logEntry);
      const debugDiv = document.getElementById("debugInfo");
      if (debugDiv) debugDiv.innerHTML = debugLogs.join("<br>");
    }

    function toggleDebug() {
      const d = document.getElementById("debugInfo");
      d.style.display = d.style.display === "none" ? "block" : "none";
    }

    // é¡µé¢æ¶ˆæ¯æ˜¾ç¤º
    function showMessage(msg) {
      document.getElementById("profileContent").innerHTML = `
        <div style="text-align:center;padding:40px 20px;color:#667eea;">
          <div style="font-size:1.2em;margin-bottom:10px;">${msg}</div>
          <div class="loading-spinner"></div>
        </div>`;
    }

    // é”™è¯¯æ˜¾ç¤º
    function showError(msg) {
      document.getElementById("profileContent").innerHTML = `
        <div class="error">
          <h3>âŒ å‡ºé”™äº†</h3>
          <p>${msg}</p>
          <button onclick="location.reload()" style="padding:8px 16px;background:#667eea;color:white;border:none;border-radius:8px;">é‡è¯•</button>
        </div>`;
    }

    // ç™»å½•æç¤º
    function showLoginPrompt() {
      document.getElementById("profileContent").innerHTML = `
        <div class="login-prompt">
          <h3 style="margin-bottom:10px;">éœ€è¦ç™»å½•</h3>
          <p style="color:#666;margin-bottom:20px;">è¯·ä½¿ç”¨ LINE ç™»å½•ä»¥æŸ¥çœ‹ä¼šå‘˜ä¿¡æ¯</p>
          <button onclick="handleLogin()" style="padding:12px 30px;background:#06c755;color:white;border:none;border-radius:25px;cursor:pointer;font-size:16px;font-weight:bold;">
            ä½¿ç”¨ LINE ç™»å½•
          </button>
        </div>`;
    }

    // ç™»å½•æµç¨‹
    async function handleLogin() {
      addDebugLog("å¼€å§‹ç™»å½•...");
      try {
        const redirect = window.location.href.split("?")[0];
        liff.login({ redirectUri: redirect });
      } catch (e) {
        addDebugLog("ç™»å½•é”™è¯¯", e.message);
        showError("ç™»å½•å¤±è´¥: " + e.message);
      }
    }

    // æ˜¾ç¤ºä¼šå‘˜ä¿¡æ¯
    function displayProfile(profile) {
      addDebugLog("æ˜¾ç¤ºä¼šå‘˜ä¿¡æ¯", profile);
      document.getElementById("profileContent").innerHTML = `
        <div class="points-card">
          <div style="font-size:0.9em;opacity:0.9;">å½“å‰ç§¯åˆ†</div>
          <div style="font-size:3em;font-weight:bold;margin:10px 0;">${profile.points}</div>
          <div>Points</div>
        </div>
        <div style="background:#f8f9fa;padding:20px;border-radius:12px;margin:20px 0;">
          <div style="display:flex;justify-content:space-between;margin:12px 0;">
            <span>ä¼šå‘˜å§“å</span><span style="font-weight:bold;">${profile.displayName}</span>
          </div>
          <div style="display:flex;justify-content:space-between;margin:12px 0;">
            <span>æ€»æ¶ˆè´¹é¢</span><span style="font-weight:bold;">ï¿¥${(profile.totalSpent||0).toLocaleString()}</span>
          </div>
        </div>
        <div style="background:#fff3cd;border:2px solid #ffc107;border-radius:10px;padding:15px;margin:20px 0;">
          <div style="font-weight:bold;color:#856404;">ğŸ”‘ ä¼šå‘˜ID</div>
          <div style="background:white;padding:10px;border-radius:6px;font-family:'Courier New',monospace;font-size:0.8em;word-break:break-all;margin:10px 0;">
            ${profile.userId}
          </div>
          <small style="color:#856404;">è¯·å‘åº—å‘˜å‡ºç¤ºæ­¤IDè¿›è¡Œç§¯åˆ†æ“ä½œ</small>
        </div>`;
    }

    // åŠ è½½ä¼šå‘˜æ•°æ®
    async function loadMemberData(userId, displayName) {
      addDebugLog("åŠ è½½ä¼šå‘˜æ•°æ®", { userId });
      showMessage("æ­£åœ¨åŠ è½½ä¼šå‘˜ä¿¡æ¯...");
      try {
        const params = new URLSearchParams({
          method: "getUserProfile",
          userId,
          displayName,
          _t: Date.now(),
        });
        const res = await fetch(`${CONFIG.GAS_WEB_APP_URL}?${params}`);
        const data = await res.json();
        if (data.status === "success") displayProfile(data.profile);
        else throw new Error(data.message || "æœåŠ¡å™¨è¿”å›é”™è¯¯");
      } catch (e) {
        addDebugLog("åŠ è½½å¤±è´¥", e.message);
        showError("åŠ è½½å¤±è´¥: " + e.message);
      }
    }

    // ä¸»åˆå§‹åŒ–
    async function initLiff() {
      addDebugLog("=== åˆå§‹åŒ– LIFF ===");
      try {
        await liff.init({ liffId: CONFIG.LIFF_ID });
        addDebugLog("LIFF åˆå§‹åŒ–æˆåŠŸ");

        if (!liff.isLoggedIn()) {
          showLoginPrompt();
          return;
        }

        const profile = await liff.getProfile();
        addDebugLog("è·å– LINE Profile æˆåŠŸ", profile);

        await loadMemberData(profile.userId, profile.displayName);
      } catch (e) {
        addDebugLog("åˆå§‹åŒ–é”™è¯¯", e.message);
        showError("åˆå§‹åŒ–å¤±è´¥: " + e.message);
      }
    }

    window.onload = () => {
      showMessage("ç³»ç»Ÿåˆå§‹åŒ–ä¸­...");
      initLiff();
    };
  </script>
</body>
</html>
