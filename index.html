const CONFIG = {
    LIFF_ID: '2008235894-KBlBRgrN',
    GAS_WEB_APP_URL: 'https://gas-proxy.miyavinail.workers.dev'  // 确保这是正确的Worker URL
};

// 初始化LIFF
async function initializeLiff() {
    console.log('=== LIFF初始化开始 ===');
    
    try {
        if (!/Line/i.test(navigator.userAgent)) {
            console.log('不在LINE环境中，显示手动输入');
            showManualInput();
            return;
        }

        await liff.init({ liffId: CONFIG.LIFF_ID });
        console.log('✅ LIFF初始化成功');
        
        if (!liff.isLoggedIn()) {
            console.log('用户未登录，执行登录');
            liff.login();
            return;
        }

        const profile = await liff.getProfile();
        console.log('✅ 获取LINE用户信息成功:', profile);
        
        // 调用会员数据 - 确保传递method参数
        await loadMemberData(profile.userId, profile.displayName);
        
    } catch (error) {
        console.error('❌ LIFF初始化失败:', error);
        showManualInput();
    }
}

// 加载会员数据
async function loadMemberData(userId, displayName) {
    console.log('开始加载会员数据:', userId, displayName);
    
    showMessage('正在加载您的会员信息...');
    
    try {
        // 修改这里：getUserProfileWithName → getUserProfile
        const url = `${CONFIG.GAS_WEB_APP_URL}?method=getUserProfile&userId=${encodeURIComponent(userId)}&displayName=${encodeURIComponent(displayName || '')}`;
        
        console.log('请求URL:', url);
        
        const response = await fetch(url);
        const data = await response.json();
        
        console.log('API响应:', data);
        
        if (data.status === 'success') {
            displayProfile(data.profile, data.isNewUser);
        } else {
            throw new Error(data.message || '未知错误');
        }
    } catch (error) {
        console.error('获取会员数据错误:', error);
        showError('系统错误: ' + error.message, userId);
    }
}

